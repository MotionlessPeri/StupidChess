# RuleSpec

## 1. 生命周期状态机

1. `SetupCommit`
2. `SetupReveal`
3. `Battle`
4. `GameOver`

### 1.1 SetupCommit

1. 双方提交盲摆承诺哈希（Commit）。
2. 未完成双方 Commit 前不得进入 Reveal。

### 1.2 SetupReveal

1. 双方提交摆子明文与随机串（Nonce）。
2. 服务端验证 `Hash(SetupPlain) == CommitHash`。
3. 验证通过后生成初始局面并进入 `Battle`。

## 2. 棋子状态

1. `HiddenSurface`：按 `SurfaceRole` 走。
2. `RevealedActual`：按 `ActualRole` 走。
3. 触发切换条件：该棋子首次吃子。
4. 切换是永久行为，不可逆。

## 3. 冻结规则

1. 切换瞬间检查当前位置是否满足实际职业位置合法性。
2. 不满足则置 `bFrozen=true`。
3. 冻结效果：
   - 不能移动。
   - 不产生攻击威胁。
   - 仍占据棋盘格位。
   - 可被对手吃掉。

## 4. 行棋与合法性

1. 未切换棋子使用表面职业规则生成候选步。
2. 已切换棋子使用实际职业规则生成候选步。
3. 对候选步做“自家将帅安全”过滤，得到合法步。
4. 合法步为空且未被将军时可 `Pass`。
5. 合法步非空时不可 `Pass`。

## 5. 将军与终局

1. 将死：当前方被将军且无合法应对，立即判负。
2. 双方连续各一次 `Pass`，判和。
3. 认输、超时等工程性终局由服务器统一判定。

## 6. 信息可见性

1. 未切换棋子的实际职业对对手不可见。
2. 切换后实际职业对双方可见。
3. 被吃棋子实际职业对双方公开。
4. 服务器存储全量真值，客户端仅接收对应视角可见数据。

## 7. 不可更改的兼容要求

1. 规则引擎输出需确定性。
2. 同一输入日志在所有平台回放必须得到同一终局。
3. 协议必须支持断线重连的增量补发。
4. 协议侧必须支持 `C2S_PullSync` 与 `C2S_Ack`，用于重连续拉与游标确认。

## 8. 当前回归断言基线

以下行为必须持续通过自动化测试：

1. 同侧重复 `Commit` 必须拒绝。
2. `CommitHash` 与 `Reveal` 不匹配必须拒绝。
3. `Reveal` 出现非法摆放位置必须拒绝。
4. 有合法步时 `Pass` 必须拒绝。
5. 在被将军状态下，`Pass` 与不解将的着法必须拒绝。
6. 首次吃子触发职业切换；若切换后落点不满足实际职业位置合法性，棋子必须冻结。
7. 对手视角下，未切换棋子必须显示 `SurfaceRole`；己方视角始终可见自身 `ActualRole`。
8. 会话事件日志必须按单调递增 `Sequence` 拉取，并支持按游标增量补发。
9. 服务端对玩家 `Ack` 的事件游标必须单调不回退，且不能超过当前会话最新 `Sequence`。
10. 重连默认从玩家 `LastAckedSequence` 续拉；客户端显式指定游标时可执行全量重拉。
